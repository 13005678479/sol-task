# MetaNode Staking System

ä¸€ä¸ªåŸºäºåŒºå—é“¾çš„å¤šä»£å¸è´¨æŠ¼ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§ä»£å¸çš„è´¨æŠ¼ï¼Œå¹¶åŸºäºç”¨æˆ·è´¨æŠ¼çš„ä»£å¸æ•°é‡å’Œæ—¶é—´é•¿åº¦åˆ†é… MetaNode ä»£å¸ä½œä¸ºå¥–åŠ±ã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **å¤šä»£å¸è´¨æŠ¼**: æ”¯æŒå¤šç§ ERC20 ä»£å¸å’ŒåŸç”Ÿ ETH è´¨æŠ¼
- âœ… **çµæ´»çš„æ± é…ç½®**: æ¯ä¸ªè´¨æŠ¼æ± å¯ç‹¬ç«‹é…ç½®æƒé‡ã€æœ€å°è´¨æŠ¼é‡‘é¢ã€é”å®šæœŸç­‰
- âœ… **å¥–åŠ±åˆ†é…**: åŸºäºè´¨æŠ¼æ•°é‡å’Œæ—¶é—´çš„åŠ¨æ€å¥–åŠ±è®¡ç®—
- âœ… **æ—¶é—´é”æœºåˆ¶**: è§£é™¤è´¨æŠ¼éœ€è¦ç­‰å¾…é”å®šæœŸ
- âœ… **æš‚åœ/æ¢å¤**: æ”¯æŒåˆçº¦æ“ä½œçš„æš‚åœå’Œæ¢å¤
- âœ… **ç´§æ€¥æå–**: ç®¡ç†å‘˜å¯è¿›è¡Œç´§æ€¥ä»£å¸æå–

### å®‰å…¨ç‰¹æ€§
- ğŸ”’ **é‡å…¥æ”»å‡»ä¿æŠ¤**: ä½¿ç”¨ OpenZeppelin çš„ ReentrancyGuard
- ğŸ”’ **æƒé™æ§åˆ¶**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- ğŸ”’ **æš‚åœæœºåˆ¶**: å¯åœ¨ç´§æ€¥æƒ…å†µä¸‹æš‚åœæ“ä½œ
- ğŸ”’ **è¾“å…¥éªŒè¯**: å…¨é¢çš„å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†

## ç³»ç»Ÿæ¶æ„

### åˆçº¦ç»“æ„
```
src/
â”œâ”€â”€ MetaNodeStaking.sol    # ä¸»è´¨æŠ¼åˆçº¦
â”œâ”€â”€ MetaNodeToken.sol      # MetaNode ä»£å¸åˆçº¦
â””â”€â”€ contracts/             # æ¥å£å’Œåº“
```

### æ•°æ®ç»“æ„

#### Pool (è´¨æŠ¼æ± )
```solidity
struct Pool {
    IERC20 stToken;              // è´¨æŠ¼ä»£å¸åœ°å€
    uint256 poolWeight;           // è´¨æŠ¼æ± æƒé‡
    uint256 lastRewardBlock;      // æœ€åä¸€æ¬¡è®¡ç®—å¥–åŠ±çš„åŒºå—å·
    uint256 accMetaNodePerST;     // æ¯ä¸ªè´¨æŠ¼ä»£å¸ç´¯ç§¯çš„MetaNodeæ•°é‡
    uint256 stTokenAmount;        // æ± ä¸­çš„æ€»è´¨æŠ¼ä»£å¸é‡
    uint256 minDepositAmount;     // æœ€å°è´¨æŠ¼é‡‘é¢
    uint256 unstakeLockedBlocks;  // è§£é™¤è´¨æŠ¼çš„é”å®šåŒºå—æ•°
    bool exists;                  // æ± æ˜¯å¦å­˜åœ¨
}
```

#### User (ç”¨æˆ·æ•°æ®)
```solidity
struct User {
    uint256 stAmount;                           // ç”¨æˆ·è´¨æŠ¼çš„ä»£å¸æ•°é‡
    uint256 finishedMetaNode;                   // å·²åˆ†é…çš„MetaNodeæ•°é‡
    uint256 pendingMetaNode;                    // å¾…é¢†å–çš„MetaNodeæ•°é‡
    mapping(uint256 => UnstakeRequest) requests; // è§£è´¨æŠ¼è¯·æ±‚
    uint256[] requestIds;                       // è¯·æ±‚IDåˆ—è¡¨
}
```

## å®‰è£…å’Œè®¾ç½®

### 1. ç¯å¢ƒè¦æ±‚
- Node.js >= 16.0.0
- npm æˆ– yarn

### 2. å®‰è£…ä¾èµ–
```bash
npm install
```

### 3. ç¯å¢ƒé…ç½®
```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„ç§é’¥å’Œ RPC URL
```

## æœ¬åœ°å¼€å‘

### 1. ç¼–è¯‘åˆçº¦
```bash
npm run compile
```

### 2. è¿è¡Œæµ‹è¯•
```bash
npm run test
```

### 3. å¯åŠ¨æœ¬åœ°èŠ‚ç‚¹
```bash
npm run node
```

### 4. éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œ
```bash
npm run deploy:local
```

## Sepolia æµ‹è¯•ç½‘éƒ¨ç½²

### 1. éƒ¨ç½²åˆçº¦
```bash
npm run deploy:sepolia
```

### 2. éªŒè¯åˆçº¦
```bash
npm run verify:sepolia -- <CONTRACT_ADDRESS> <CONSTRUCTOR_ARGS>
```

## ä½¿ç”¨æŒ‡å—

### è´¨æŠ¼æ“ä½œ

```javascript
// 1. æˆæƒä»£å¸
await stakingToken.approve(stakingAddress, amount);

// 2. è´¨æŠ¼ä»£å¸
await staking.stake(poolId, amount);

// 3. æŸ¥çœ‹å¾…é¢†å–å¥–åŠ±
const pending = await staking.getPendingReward(poolId, userAddress);

// 4. é¢†å–å¥–åŠ±
await staking.claimReward(poolId);

// 5. è¯·æ±‚è§£é™¤è´¨æŠ¼
await staking.requestUnstake(poolId, amount);

// 6. å¤„ç†è§£è´¨æŠ¼ (é”å®šæœŸå)
await staking.processUnstake(poolId, requestId);
```

### ç®¡ç†å‘˜æ“ä½œ

```javascript
// æ·»åŠ è´¨æŠ¼æ± 
await staking.addPool(
    tokenAddress,      // è´¨æŠ¼ä»£å¸åœ°å€
    poolWeight,        // æ± æƒé‡
    minDepositAmount,  // æœ€å°è´¨æŠ¼é‡‘é¢
    lockBlocks         // é”å®šåŒºå—æ•°
);

// æ›´æ–°æ± é…ç½®
await staking.updatePool(poolId, newWeight, newMinDeposit, newLockBlocks);

// æ›´æ–°å¥–åŠ±é€Ÿç‡
await staking.updateMetaNodePerBlock(newRate);

// æš‚åœ/æ¢å¤åˆçº¦
await staking.pause();
await staking.unpause();
```

## Gas ä¼˜åŒ–ç­–ç•¥

### 1. å­˜å‚¨ä¼˜åŒ–
- ä½¿ç”¨ packed structs å‡å°‘å­˜å‚¨æ§½ä½¿ç”¨
- æ‰¹é‡æ“ä½œå‡å°‘äº‹åŠ¡æ•°é‡

### 2. è®¡ç®—ä¼˜åŒ–
- ä½¿ç”¨ unchecked å—è¿›è¡Œå®‰å…¨çš„æ•°å­¦è¿ç®—
- ç¼“å­˜é‡å¤è®¡ç®—ç»“æœ

### 3. äº‹ä»¶ä¼˜åŒ–
- ä½¿ç”¨ indexed å‚æ•°å‡å°‘ Gas æ¶ˆè€—
- åˆç†è®¾è®¡äº‹ä»¶ç»“æ„

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•
- âœ… æ± ç®¡ç†åŠŸèƒ½
- âœ… è´¨æŠ¼/è§£è´¨æŠ¼åŠŸèƒ½
- âœ… å¥–åŠ±è®¡ç®—å’Œé¢†å–
- âœ… æƒé™æ§åˆ¶
- âœ… æš‚åœ/æ¢å¤æœºåˆ¶
- âœ… é”™è¯¯å¤„ç†

### é›†æˆæµ‹è¯•
- âœ… å®Œæ•´è´¨æŠ¼æµç¨‹
- âœ… å¤šç”¨æˆ·äº¤äº’
- âœ… æ—¶é—´é”æœºåˆ¶
- âœ… ç´§æ€¥æƒ…å†µå¤„ç†

## å®‰å…¨å®¡è®¡è¦ç‚¹

1. **é‡å…¥æ”»å‡»é˜²æŠ¤**: æ‰€æœ‰çŠ¶æ€ä¿®æ”¹åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å‰
2. **æ•´æ•°æº¢å‡ºæ£€æŸ¥**: ä½¿ç”¨ Solidity 0.8+ çš„å†…ç½®ä¿æŠ¤
3. **æƒé™éªŒè¯**: ä¸¥æ ¼çš„è§’è‰²å’Œæƒé™æ§åˆ¶
4. **è¾“å…¥éªŒè¯**: å…¨é¢çš„å‚æ•°éªŒè¯
5. **äº‹ä»¶æ—¥å¿—**: å®Œæ•´çš„æ“ä½œå®¡è®¡è·Ÿè¸ª

## ç›‘æ§å’Œç»´æŠ¤

### å…³é”®æŒ‡æ ‡
- æ€»è´¨æŠ¼é‡ (TVL)
- å„æ± è´¨æŠ¼åˆ†å¸ƒ
- å¥–åŠ±å‘æ”¾æƒ…å†µ
- Gas æ¶ˆè€—ç»Ÿè®¡

### è¿ç»´æ“ä½œ
- å¥–åŠ±é€Ÿç‡è°ƒæ•´
- æ–°æ± æ·»åŠ 
- åˆçº¦å‡çº§
- ç´§æ€¥å“åº”

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ·»åŠ æ–°çš„è´¨æŠ¼ä»£å¸ï¼Ÿ
A: ç®¡ç†å‘˜å¯ä»¥è°ƒç”¨ `addPool` å‡½æ•°æ·»åŠ æ”¯æŒæ–°ä»£å¸çš„è´¨æŠ¼æ± ã€‚

### Q: é”å®šæœŸå¦‚ä½•è®¡ç®—ï¼Ÿ
A: é”å®šæœŸä»¥åŒºå—ä¸ºå•ä½ï¼Œå…·ä½“æ•°å€¼åœ¨åˆ›å»ºæ± æ—¶é…ç½®ã€‚

### Q: å¥–åŠ±å¦‚ä½•åˆ†é…ï¼Ÿ
A: å¥–åŠ±åŸºäºæ± æƒé‡å’Œç”¨æˆ·è´¨æŠ¼æ¯”ä¾‹åŠ¨æ€åˆ†é…ï¼Œé‡‡ç”¨å¤åˆ©è®¡ç®—æ–¹å¼ã€‚

## å¼€å‘å›¢é˜Ÿ

- **æ™ºèƒ½åˆçº¦å¼€å‘**: MetaNode Task Team
- **å®‰å…¨å®¡è®¡**: å»ºè®®è¿›è¡Œä¸“ä¸šå®‰å…¨å®¡è®¡
- **æµ‹è¯•è¦†ç›–**: å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

## è®¸å¯è¯

MIT License

## å…è´£å£°æ˜

æœ¬é¡¹ç›®ä»…ç”¨äºå­¦ä¹ å’Œæ¼”ç¤ºç›®çš„ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼Œè¯·è¿›è¡Œå……åˆ†çš„å®‰å…¨å®¡è®¡å’Œæµ‹è¯•ã€‚